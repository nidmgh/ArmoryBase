数据库打工仔在擦拭枪支时，喃喃自语的八卦历史

# 可靠性: mainframe vs. Mosin Nagant

一个软件工程师, 枪支爱好者，历史八卦者的喃喃自语


## 数据库的可靠性
### 定义和设计
系统RAS(Reliability, availability and serviceability)概念最早是由IBM提出[[1]](#1)来形容曾经是神一样存在的主机（也叫大机，mainframe)。为什么说神一样的存在呢？主机是第一批商用计算机，1950出现，活跃至今，最新版本为2019.9月的z15。最早的一批商用数据库就包括主机上的DB2/z(1983年GA v2.3)。也许你从没有听说过，但是如果你每一天在消费，过程中，不论银行卡，支付宝，微信都会最终走到银联，而且很可能是工农建交等大银行。那么你的交易就是在主机上完成和记录的。神在我们身边，而无痕迹....

我们谈论数据库的可靠性时候，笼统的时候会泛指RAS，大部分时候单指Reliability。

- **可靠性**Reliability: 数据库系统无故障可以持续运行的能力。MTBF(Mean Time Between Failure)/MTTF(Mean Time to Faillure)，MTTR(Mean Time to Repair/Recover)。这些都是工业界通用的衡量标准。具体计算公式大家自己去Google/wiki。这里盗个图凑数
![](../images/02-Time_between_failures.png)

<!--
- **可用性**Availability：系统在指定时间内可正常工作的概率。
  比如说云原厂上经常会提到的SLA，N个九。近是十年流行的“双活”，“两地三中心”等等方案都是提高可用性的最佳实践方案。
- **可维护性**Serviceability：若故障发生，检查和维修需要的时间
-->
### 坑是无处不在的
怎么能不犯错？do nothing; 要保证软件不出bug? 一行不写。如果不得不code呢？可靠方面先思考这两项

- 核心代码的复杂度

架构设计有个说法K.I.S.S(Keep it Simple, Stupid!)。其实系统软件的核心code, 扬名天下立万的骨架，也就那么几万行，完成系统80%的工作，换句话说，系统连续运行过程中每小时（甚至每分钟）都必然运行的code logic。这些code中简洁易懂是系统存活的关键。

**简洁**可减少系统的bug。MySQL依赖最简单可靠的nest-loop join算法二十多年，而"先进"的Hash Join是在最近两年才实现，在MySQL8.0.18正式GA。从算法复杂度看(两个都有改进版本)，[Nest Loop J](https://en.wikipedia.org/wiki/Nested_loop_join)是O(MN), [Hash J](https://en.wikipedia.org/wiki/Hash_join)是O(M+N)。Hash join 在教科书里属于advance的章节，直接翻译是“进步”，褒义词。可是另一方面，几乎所有的advance技术都更复杂(电车是个反例，降维打击了），需要更多或更特殊的资源才能发挥其能力。Hash Join就需要在大内存支持下才能发挥，否则要么OOM，要么落盘造成性能断崖，尤其不适合高并发的TP场景。比如各位同学中午在食堂买饭，就是高并发场景，如果系统中突然出现一个大查询把内存都吃掉，也把各位的饭就吃掉了。如何解决这个问题呢？workload management(WLM) 就要被引入，以自动调低“烂”query的优先级，限制其资源。而又引入进一步的系统复杂度。nest loop保证了每个join的内存空间消耗是固定的，所以在上面场景中，不用WLM，不用系统DBA也可以保证各位吃上午饭。

给我自己顶个锅盖保护一下，绝没有想引战NLJ vs HJ的意思，PG有比较完整成熟的优化器，就好很多。靠，又引战MySQL vs PG 了。

只是想说，如果一个系统可以简单化，就可以减少其bug数，增加可靠性。当然，我猜50%以上的人也不是因为对数据库有兴趣才读这个文章吧？同不同意的，大家都忽略呀。

有兴趣研究软件工程的东西，可以看看Unix philosophy。哲学的事情咱不懂，用数据说话，第一版Unix据称是不到5千行的汇编语言；linux 0.0.1版是10243(C) 和386(汇编)。多年前，我参与系统软件项目排期的时候，是按1.5KLoC/Person-Year 做的计划。所以偶尔听说系统开发同学谈绩效的时候提一年几万行代码，还经常是早春二三月份提交的，兄弟我怕呀。前端同学代码量会多些，不过这些代码的生命力会差些。其实我认为衡量一个开发的代码能力不应简单的line of code, 应该与服务年挂勾

<!-- 华为：圣无线，神终端，海屌丝，大爷软，科学家  -->

- 测试

这方面经常在数据库设计和实现过程中被忽略，尤其在相对不成熟的开发团队中
只做简单的功能测试，甚至是单逻辑flow，而不考虑边界条件，更谈不上系统压力测试(system stress testing)。比如说连接数/concurrency突然提升情况下，是否还能够保证吞吐量和延时保持着正常水平，而不会因为高压力下造成系统完全不可用。

写code就会有bug, 越早发现fix的成本约少。软件工程中这张图是1996s的文章。每每在前线客户反馈一个简单的bug, 我脑海里就是这张图和16000美刀
![](../images/02-cost-to-fix-bug.jpeg)

鄙视链那都有，软件开发也不例外，常常一方面说测试多么重要，一方面测试工程师的工资级别属于末端集结号。自然没有牛人过来投入。这是全球普世的，而某些团队尤甚。尤其是近些年，开始学Agile，学开源，甚至不设测试岗位。殊不知，开源社区最注重测试，测试代码量常常是产品代码的3X。笔者有幸十年前在HBase社区打酱油，很是佩服一个健康社区对代码质量的管理。而当时的主席Stack，自号Hbase Janitor（清洁工），最重要的工作就是QA。

试问你所在的团队，产品发布时，最后的否决权是否在测试手里？猪肉出厂还要盖个质检章呢。如果客户现场发现了一个bug, 你的团队的复盘中，是否能确认这个bug应该在软件工程的那个环节被发现？
![](../images/02-porkQA.jpg)

<!--
- 高可用
MySQL M-S
MySQL three node paxos
Aurora/PolarDB/DocumentDB - Global database: ....? 

- 可维护性：
这方面在数据库早期设计和实现过程几乎一定是被忽略的。prototype能运转就行，谁还有空考虑服务？即使是有了2～3年商用的数据库产品，常常是没有规范的服务模块的。一个产品有没有可维护性设计只需要看两个东西：
1) grep 它的出错信息，是否可以帮助用户自诊断？
2) 系统crash或者dump, 有无说明收集什么样的信息，已供debug不可复现的问题？  
-->

## 枪的可靠性

在任何时候和地点，在极端天气下，当扣动扳机的时候，总可以打响。
那么一把1940s年代的生产的[Mosin–Nagant莫辛-納甘步槍](https://zh.wikipedia.org/wiki/%E8%8E%AB%E8%BE%9B-%E7%B4%8D%E7%94%98%E6%AD%A5%E6%A7%8D),
加上1960年代的军剩弹（military
surplus)。在2021年还可以正常运转，是否算是可靠呢？


![Mosin-Nagant M44\label{02-M44}](../images/02-M44.jpg?raw=true)

- 子弹型号：7.62×54R （原厂）
- 枪口初速：800米／秒
- 有效射程：500米(800米+ 瞄准镜）
- 服务年代： 1891 ～至今
- 生产年代：1891 ～ 1973
- 生产数量：三千七百万只（约）


根据它的出厂标记，是1944年在前苏联的兵工厂
Izhevsk(伊熱夫斯克)出品的[Soviet M44](http://7.62x54r.net/MosinID/MosinM44S.htm)
当时第二次世界大战接近尾声，预计苏联红军进攻德国过程中
将有很多在城市发生的巷战，故设计了这款卡宾式，
比原始M91/30款短20公分，是之前M38式的升级版。
从1943开始，该兵工厂大约出产五万把M44

![Mosin-Nagant
M44\label{02-Stamp}](../images/01-LeVieuxFusil.jpg?raw=true)

上图这个简单的“出场/厂”标记（故意模糊了）代表她的生日，
也打上了工程师的印记。
就好像数据库的每一行code
都能追溯到他的制造者。这就是上面提到的出场时的质检章。
卫国战争中，苏联兵工厂的工人大部分是妇女。我记得一个艺术加工后的场景中(某电影？)，兵工厂出现了残次品。
政治委员召集工人们开会说，“你们的丈夫，儿子，父亲的生命就是在这把枪上。不要让亲人死在你的手里”。

当一个开发用呵护培养儿女的心写code的时候，她他就不会为三个月的短期目标commit code，让孩子长歪了，比如"My"SQL和“Maria”DB。
不过做正确的事情很难的，我在压力下往repo里扔的烂code估计不比其他人少。"I always knew what the right path was. ....It was too damn hard."。

### 八卦篇
那么这把1940年代的老枪是如何转半个地球来到硅谷的？
追溯一下历史：

**Hard模式**：前苏联军队最后一个大规模战役，是在1945.8.3对日宣战，
攻入中国的东北，这把枪一起带了过来，之后辗转流入到
东北抗日联军手里。而金日成就曾任东北抗日联军第一支队
支队长，后第一营营长。1945年，他从苏联返回朝鲜北部，
建立朝鲜共产党中央组织委员会。
1951朝鲜战争爆发，在漫长的五次战役中，可能有一只M44流落到一个美国大兵手里，
60年后，他的孙子卖给了一个硅谷数据库码农。

**Easy模式**：四四年出厂欧州战已经基本结束。而且新出产的SKS（中国称五六半）和后来的AK47（中国五六全)，
渐渐升级给前方的正规军, Mosin终于到退出历史舞台的时候。
从岁月的痕迹看，这把枪还是服役过的，也许是某个民兵部队。
岁月把它埋到战略储备中，层层凡士林保护1991年，苏联轰然解体。
大量的军事装备被廉价的出口到了美国，50刀一把。

Hard模式是笔者纯粹的臆想，却也不无根据。Mosin在中国的仿制型为“53式步骑枪”
中国人民志愿军最著名的狙击手张桃芳所使用的其中一种武器是莫辛-纳甘M1944卡宾枪。
有图有真相。也有人说这是摆拍的，他主要用的是缴获的美国造，这就不深究了。

![张桃芳Mosin-Nagant M44\label{02-ztf}](../images/02-ztf.jpg?raw=true)


不论我们多么希望浪漫的想象中的hard, 这把M44身上被打上的pw arms的标记stamp,
告诉我们它是一个通过easy模式来的进口货.

### 优势篇
(本来起名“架构篇”，后来发现自己不懂架构)
Mosin之所以可以在发明五十年之后还被用到二战的主战场，《兵临城下》anyone? 主要原因：高可靠，低成本(易批产)，易维护

![](../images/02_Enemy_at_the_gates.jpeg)

**高可靠，低成本(易批产)，易维护**， 收一收，怎么又扯偏了？这不是某云数据库常常用的话术？

莫辛-纳甘的部件是34个，如果把枪栓也拆开，大约40个。对比一下AR-15大约200个，AK-47将近100，可谓简单了。
因为历史原因(自动步枪还没有发明)，莫辛采用栓动而且没有弹夹，都大大减少了系统复杂度。
同时设计过程中不考虑模块化设计(这又是一个“advance"技术)，所以不用设计枪管，板机，枪托等可升级部件。
莫辛虽然又几个不同款式,1891步兵, M38卡宾, M44卡宾, PU Sniper狙击步枪, 但是工艺上不保证款式之间的零件互换，这就又减轻了一层设计和开发的负担。

另一方面，部件数量降低工程难度和减少工序流程，零件容错的间隙大，使更多的兵工厂和作坊可以生产。
苏联的这种设计理念，延续到后来的SKS和AK47系列。除了枪管以外，AK是可以手工打造的(stamped receivers)。

易维护，这里是亚麻上售卖的莫辛-纳甘[擦枪工具](https://www.amazon.com/TACFUN-Mosin-Nagant-Cleaning-7-62x54R/dp/B00VPWI3G0)。那个小布包大约三个并排手指的长宽。苏联军队的子弹是有腐蚀性，它的底火触发后会存留盐，这对当时的铁枪是又致命伤害的，需要立刻可溶解盐的洗涤液，或者至少是热水清洗。那么在困难的斯大林格勒保卫战中，没有热水呢？发挥一下大家的想象力。

简单、皮实、耐操（打住！怎么某司价值观又上来了？）是莫辛-纳甘公认的特点。有兴趣的，可以去youtube, 看“mosin nagant torture test”，对，就叫酷刑试验。类似数据库的stress test, 刀砍斧劈拔电源。

## 尾巴
美国的枪支爱好者中，有一类枪被归类为SHTF survival rifle。 对这类枪支有很多纬度的衡量，常常用两种“业务”场景（对，推广数据库关键也是场景）

1）假设僵尸爆发了，你和家人如何生存？“僵尸”是一个特色词汇，代表含义比较广
2）假设世界末日，躲到了野外，如果打猎（钓鱼）生存

SHTF的场景下，可靠性和便携性，常常是首当其冲的。莫辛-纳甘虽不是首选，也可以拿到荣誉奖。不只因为上面推崇的可靠性，因为它和子弹都“曾经”很廉价，我2015年花了250刀左右买的上面照片中的M44(后来在家门口的big 5 发现一把sniper PU，只要5百，人穷就没有远见呀）, 同年花$100买了没有开封的440发装的军队剩单。后来有用一百买了开封的500发。为了准备SHTF，可以把这把枪和子弹埋在地下，几十年后，挖出来，**still get the job done**。请问，各位专家们，有什么样的产品，可以有此殊荣？
![](../images/02-54r-spamcan.jpg) 

注：我今年发奖金后，LD批准买了一把survival rifle。有机会讲讲它

`ls -al`了一下，～14000字节，有4千字吧。本次喃喃自语结束
 
## References
<a id="1">[1]</a> 
Data Processing Division, International Business Machines Corp., 1970 (1970). "Data processor, Issues 13-17". - "The dependability [...] experienced by other System/370 users is the result of a strategy based on RAS (Reliability-Availability-Serviceability) - citication copy from wiki

![](../images/ywm.gif?raw=true)


